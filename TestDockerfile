# TestDockerfile for running ndt-server integration tests.
#
# This simplified version focuses on NDT7 testing using ndt7-client-go.
# Legacy NDT5 client builds (libndt, measurement-kit, web100clt) have been
# removed due to compatibility issues with modern compilers.

FROM golang:1.25-bookworm as final
WORKDIR /

# Install runtime dependencies
RUN apt-get update && apt-get install -y git nodejs npm

ENV GOPATH=/go

# Install test tools
RUN go install github.com/mattn/goveralls@latest
RUN go install github.com/m-lab/ndt7-client-go/cmd/ndt7-client@latest

# Add source code and build
ADD . /go/src/github.com/m-lab/ndt-server
WORKDIR /go/src/github.com/m-lab/ndt-server/testdata
RUN npm install .
WORKDIR /go/src/github.com/m-lab/ndt-server
RUN ./build.sh

CMD /bin/bash ./test.sh

# To build and run tests:
#    docker build -f TestDockerfile . -t ndttest && docker run -it ndttest
