<!doctype html>
<html lang='en'>
<head>
  <script type='text/javascript' src='ndt7-core.js'></script>
  <style>

.row {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  width: 100%;
}

.result {
  position: relative;
  align-items: center;
  justify-content: center;
  font-size: 1000%;
  align: center;
}
  </style>
  <meta charset='utf-8'>
  <title>ndt7 Speed Test</title>
</head>
<body>
  <div>
    <div id='downloadShort' class='result row'>[Download (short)]</div>
    <div id='downloadLong' class='result row'>[Download (long)]</div>
    <div id='uploadShort' class='result row'>[Upload (short)]</div>
    <div id='uploadLong' class='result row'>[Upload (long)]</div>
  </div>
  <script type='text/javascript'>
    /* jshint esversion: 6, asi: true */
    /* globals ndt7core */

    function withElementDo(elementId, callable) {
      const elem = document.getElementById(elementId)
      if (elem) {
        callable(elem)
      }
    }

    function updateView(elementId, appInfo) {
      withElementDo(elementId, function (elem) {
        const elapsed = appInfo.ElapsedTime / 1e06     /* second */
        let speed = appInfo.NumBytes / elapsed         /* B/s    */
        speed *= 8                                     /* bit/s  */
        speed /= 1e06                                  /* Mbit/s */
        elem.innerHTML = speed.toFixed(3) + ' Mbit/s'
      })
    }

    function runSomething(url, testName, suffix, callback) {
      ndt7core.run(url, testName, function(ev, val) {
        console.log(ev, val)
        if (ev === 'complete') {
          if (callback !== undefined) {
            callback()
          }
          return
        }
        if (ev === 'measurement' && val.AppInfo !== undefined &&
            val.Origin === 'client') {
          updateView(testName+suffix, val.AppInfo)
        }
      })
    }

    function runDownload(callback) {
      runSomething(location.href, 'download', 'Short', callback);
    }

    function runUpload(callback) {
      runSomething(location.href, 'upload', 'Short', callback);
    }

    function runLongUpload() {
      const regex = /param_/g; // make parameters unrecognizable to server.
      runSomething(location.href.replace(regex, ''), 'upload', 'Long');
    }
    function runLongDownload(callback) {
      const regex = /param_/g; // make parameters unrecognizable to server.
      runSomething(location.href.replace(regex, ''), 'download', 'Long', callback);
    }

    runDownload(function() {
      runLongDownload(function() {
        runUpload(function() {
          runLongUpload();
        });
      });
    })
  </script>
</body>
</html>
